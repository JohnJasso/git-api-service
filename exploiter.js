const EventEmitter = require('events')
const fetch = require('node-fetch');
const credentials = require('./credentials.json')
const baseURL =  'https://api.github.com/';

// class Exploiter extends EventEmitter {
//     printURL() {
//         console.log('URL: ' + BaseURL)
//         this.emit('gotURL', { id: 1, url: 'thisurl.com'})
//         // this.emit("gotURL", "thisisurl.com ");
//     }
// }

async function searchRepos(search_term) {
    const url = new URL(`${baseURL}search/repositories?q=${search_term}`);
    try {
      const response = await fetch(url);
      const json = await response.json();
      return json;
    } catch (error) {
      console.log('Server error: ', error);
    }
}

async function searchRepoByID(id) {
  const url = new URL(`${baseURL}repositories/${id}`);
  try {
    const response = await fetch(url);
    const json = await response.json();
    return json;
  } catch (error) {
    console.log("Server error: ", error);
  }
}

async function listStars() {
    const url = new URL(`${baseURL}users/${credentials.username}/starred`);
    try {
      const response = await fetch(url);
      const json = await response.json();
      console.log(json);
    } catch (error) {
      console.log("Server error: ", error);
    }
}

async function listStarsAuth() {
  const url = new URL(`${baseURL}user/starred`);
  url.username = credentials.username;
  url.password = credentials.password;
  console.log('URL:', url)
  try {
    const response = await fetch(url);
    const json = await response.json();
    console.log(json);
  } catch (error) {
    console.log("Server error: ", error);
  }
}

async function starRepoAuth(id) {
    const repo = await searchRepoByID(id);
    const repoName = await repo.full_name;
    const url = new URL(`${baseURL}user/starred/${repoName}`);
    url.username = credentials.username;
    url.password = credentials.password;
    try {
      const response = await fetch(url, {
        method: "PUT",
        headers: {
            'Content-Length': 0,
        }
      });
      const json = await response.json();
      console.log('response', json);
    } catch (error) {
        //API receives PUT request without a body
        //Fetch function returns an error but the request is made correctly
      if(error.type === 'invalid-json')
        console.log({ status: 204, message: 'No Content'})
        //return { status: 204, message: 'No Content'}
      else 
        console.log('Server error: ', error)
    }
}

async function removeStarRepoAuth(id) {
  const repo = await searchRepoByID(id);
  const repoName = await repo.full_name;
  const url = new URL(`${baseURL}user/starred/${repoName}`);
  url.username = credentials.username;
  url.password = credentials.password;
  try {
    const response = await fetch(url, {
      method: "DELETE",
      headers: {
        "Content-Length": 0,
      }
    });
    const json = await response.json();
    console.log("response", json);
  } catch (error) {
    //Fetch function returns an error but the request is made correctly
    if (error.type === "invalid-json")
      console.log({ status: 204, message: "No Content" });
    //return { status: 204, message: 'No Content'}
    else console.log("Server error: ", error);
  }
}

module.exports.search = searchRepos;
module.exports.list = listStars;
module.exports.listAuth = listStarsAuth;
module.exports.starAuth = starRepoAuth;
module.exports.remStarAuth = removeStarRepoAuth;